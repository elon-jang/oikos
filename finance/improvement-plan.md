# Finance 개선 방안

> T-Connect Skill 패턴을 기준으로 도출한 실행 가능한 개선 목록

---

## 개선 영역 요약

| # | 영역 | 대상 파일 | 우선순위 | 효과 |
|---|------|----------|---------|------|
| A | LLM 판단 정확도 향상 | `commands/process-offering.md` | **높음** | OCR 추출/분류 오류 감소 |
| B | 문서 역할 정리 | `CLAUDE.md`, `process-offering.md` | 중간 | 유지보수 용이성 |
| C | 운영 안정성 | `scripts/` | 중간 | 에러 복구, 반복 실행 안정화 |
| D | 확장성 | 프로젝트 구조 | 낮음 | 다른 교회 적용 가능성 |

---

## A. LLM 판단 정확도 향상

`process-offering.md`는 LLM이 매주 읽고 실행하는 매뉴얼입니다. T-Connect에서 검증된 5가지 문서화 패턴 중 Finance에 부족한 3가지를 보강합니다.

### A-1. 페이지 분류 의사결정 트리 추가

**현재** (테이블만 제공):

```markdown
| 내용 특징 | 유형 | 처리 |
|-----------|------|------|
| 표 형태 + "통계표" 제목 | 통계표 | 표에서 (이름, 금액) 쌍 추출 |
| 단일 전표 양식 + 금액 | 전표 | 총액 + 내역 추출 |
| 이전 페이지와 동일 내용 | 중복 | 건너뛰기 |
```

**문제**: LLM이 경계 사례(예: 통계표처럼 보이지만 전표인 경우)에서 판단이 흔들림

**개선**: 순서가 있는 의사결정 트리로 변환

```markdown
페이지를 읽은 후 아래 순서대로 분류합니다:
│
├─ Q1: 이전 페이지와 내용이 동일한가? (복사본/영수증 사본)
│   └─ Yes → **중복** (건너뛰기)
│   └─ No → Continue
│
├─ Q2: 특별헌금 키워드(송구영신, 헌신예배, 부활절 등)가 포함되어 있는가?
│   └─ Yes → **특별헌금** (사용자에게 포함 여부 질문)
│   └─ No → Continue
│
├─ Q3: 여러 줄의 (이름, 금액) 쌍이 표 형태로 나열되어 있는가?
│   └─ Yes → **통계표**
│   │   └─ 제목에서 카테고리 판별 (아래 카테고리 판별 기준 참조)
│   │   └─ 합계 행이 있으면 교차 검증 수행
│   └─ No → Continue
│
├─ Q4: 단일 건의 금액 + 부서명/단체명이 있는가?
│   └─ Yes → **전표**
│   │   └─ 부서명만 있으면 이름=부서명 (예: "장년부", "어린이부")
│   │   └─ 카테고리는 전표 제목/내용에서 판별
│   └─ No → Continue
│
└─ Q5: 위 어디에도 해당하지 않음
    └─ **기타** (사용자에게 유형 질문)
```

**적용 위치**: `process-offering.md` 2단계의 "자동 분류 기준" 섹션 교체

---

### A-2. OCR 오인식 Warning 체계화

**현재** (3줄 간략 언급):

```markdown
**금액 인식 주의사항:**
- 필기체 숫자는 오인식 가능성이 높음 (예: 50,000 → 30,000)
- 합계 불일치가 발생하면 개별 항목을 재확인하여 의심 항목을 특정
- 의심 항목은 4단계에서 `⚠ 금액 재확인 필요` 태그로 표시
```

**문제**: 금액뿐 아니라 이름, 카테고리, 구조적 오인식 패턴도 존재

**개선**: 유형별 Warning 블록으로 확장

```markdown
**⚠️ OCR 오인식 주의사항:**

**금액 오인식:**
- 필기체 숫자 혼동: 5↔3, 8↔0, 1↔7
  예: 50,000 → 30,000 / 180,000 → 100,000
- 쉼표 위치 오류: 580,000 → 58,000 또는 5,800,000
- 검증법: 통계표 합계와 개별 합산을 비교 → 불일치 시 가장 큰 차이 항목이 의심

**이름 오인식:**
- 획이 유사한 한글: 호↔모, 건↔진, 천→권, 성↔섭
  → correct_names.py가 자모 분해로 대부분 교정
- 쉼표로 연결된 부부 이름: "최정호,박경애" → 하나의 이름으로 유지 (분리하지 않음)
- 교정 불가: 3자 중 2자 이상 동시 오인식 (예: 윤순심→윤선섭)
  → unknown 처리 → 사용자 확인

**카테고리 오인식:**
- "헌금통계표" 제목에서 카테고리를 추출할 때:
  - "헌금통계표" (수식어 없음) → 십일조로 간주
  - 단, "감사 헌금통계표"의 "감사"가 잘려서 "헌금통계표"만 보이는 경우 있음
  → 합계 금액 규모로 교차 검증 (십일조는 보통 수백만원대)

**구조적 오인식:**
- 표의 열 정렬이 깨져서 이름과 금액이 어긋나는 경우
  → 행 수와 합계로 검증 (예: 18행인데 합산이 17건분이면 1건 누락)
- 빈 칸이 있는 행을 건너뛰는 경우
  → 통계표 기재 건수와 추출 건수 비교
```

**적용 위치**: `process-offering.md` 2단계의 "금액 인식 주의사항" 섹션 교체

---

### A-3. 데이터 변환 Before/After 예시 추가

**현재**: JSON 형식만 제시되어 있고, OCR 원본에서 JSON으로의 변환 과정 예시가 없음

**문제**: LLM이 OCR 추출 결과를 JSON으로 변환할 때 일관성이 떨어질 수 있음

**개선**: 실제 데이터로 End-to-End 변환 예시 추가

```markdown
### 변환 예시: 통계표 → JSON

**OCR 원본 (통계표 페이지):**
```
        감사 헌금통계표
이름          금액
정평화        50,000
장년부       150,000
권언성,하공남  80,000
합계         280,000
```

**이름 교정 결과:**
```json
[
  {"original": "정평화", "corrected": "정평화", "status": "exact"},
  {"original": "권언성", "corrected": "권언성", "status": "exact"}
]
```
→ "장년부"는 부서명이므로 이름 교정 대상이 아님

**최종 JSON (write 명령 입력):**
```json
{
  "감사": [
    {"name": "정평화", "amount": 50000},
    {"name": "장년부", "amount": 150000},
    {"name": "권언성,하공남", "amount": 80000}
  ]
}
```

**주의:**
- 금액에서 쉼표 제거: `50,000` → `50000`
- 부부 이름은 쉼표 연결 그대로 유지: `"권언성,하공남"`
- 부서명은 교정하지 않고 이름 필드에 그대로 입력: `"장년부"`
- "합계" 행은 JSON에 포함하지 않음 (검증용으로만 사용)
```

```markdown
### 변환 예시: 전표 → JSON

**OCR 원본 (전표 페이지):**
```
        장년부 주일헌금 전표
금액: ₩242,000
```

**카테고리 판별:** "주일헌금" + "장년부" → 장년부주일

**최종 JSON:**
```json
{
  "장년부주일": [
    {"name": "장년부", "amount": 242000}
  ]
}
```

**주의:**
- 부서 전표는 이름 = 부서명
- 카테고리 별칭 해석: "주일헌금" → offering_config.py의 CATEGORY_ALIASES → "장년부주일"
```

**적용 위치**: `process-offering.md` 2단계 끝, 3단계 시작 전에 새 섹션으로 추가

---

### A-4. 카테고리 판별 기준에 우선순위 부여

**현재** (나열만):

```markdown
- "헌금통계표" (수식어 없음) → 십일조
- "감사 헌금통계표" → 감사
- "생일감사" → 생일감사
- "산돌회" → 샬롬전도회
- "주일헌금" + "장년부" → 장년부주일
```

**개선**: 매칭 우선순위를 명시하고, 복합 조건을 앞에 배치

```markdown
**카테고리 판별 기준 (위에서 아래로 순서대로 적용):**

1. **복합 키워드 (먼저 확인)**
   - "주일헌금" + "장년부" → 장년부주일
   - "주일학교" → 중고등부 (문맥에 따라 다를 수 있음 → 불확실하면 사용자 질문)

2. **정확한 카테고리명 매칭**
   - "감사 헌금통계표", "감사헌금" → 감사
   - "생일감사" → 생일감사
   - "일천번제" → 일천번제
   - "장학", "장학헌금" → 장학
   - "구제", "구제헌금" → 구제
   - "월정선교", "월정헌금", "선교헌금", "정기선교" → 월정선교

3. **단체/부서명 매칭**
   - "산돌회", "산돌전도회" → 샬롬전도회
   - "갈렙전도회" → 갈렙전도회
   - "남전도회" → 남전도회
   - "안나전도회" → 안나전도회

4. **수식어 없는 기본 매칭**
   - "헌금통계표" (수식어 없음) → 십일조
   - 단, 확실하지 않으면 사용자에게 확인

5. **혼합 카테고리**
   - 하나의 페이지에 여러 카테고리가 있는 경우: 항목별로 분리
   - 카테고리를 알 수 없는 항목 → 사용자에게 질문
```

**적용 위치**: `process-offering.md` 2단계의 "카테고리 판별 기준" 섹션 교체

---

## B. 문서 역할 정리

### B-1. CLAUDE.md와 process-offering.md 역할 명확화

**현재 상태**: 두 문서에 내용이 중복되어 있음

| 내용 | CLAUDE.md | process-offering.md |
|------|:---------:|:-------------------:|
| 데이터 흐름 | O | O (수행 단계) |
| 카테고리 매핑 | O (설계 결정) | O (매핑 참고) |
| CLI 사용법 | O | O (bash 명령어) |
| 이름 교정 원리 | O | O (간략) |
| 페이지 분류 기준 | O | O |

**개선 원칙**: T-Connect의 역할 분리를 적용

```
CLAUDE.md          = "왜 이렇게 만들었는가" (설계 결정, 아키텍처, 변경 가이드)
process-offering.md = "무엇을 어떻게 실행하는가" (실행 매뉴얼, 판단 기준)
```

**구체적 변경:**

CLAUDE.md에서 제거 가능한 내용:
- "페이지 유형 자동 분류" → process-offering.md에만 유지
- "CLI 사용법" 상세 예시 → process-offering.md에 bash 명령이 이미 있으므로 CLAUDE.md는 요약만

CLAUDE.md에만 유지할 내용:
- 핵심 설계 결정 (왜 자모 분해인가, 왜 고정 슬롯인가)
- 카테고리 변경 절차
- 테스트 구조 및 실행 방법
- 개선 계획 히스토리

process-offering.md에만 유지할 내용:
- 7단계 실행 흐름 (LLM이 따라갈 매뉴얼)
- 판단 기준 (카테고리 분류, 페이지 분류)
- Warning (OCR 오인식)
- 데이터 변환 예시

---

### B-2. process-offering.md 에 역할 분담표 추가

T-Connect의 SKILL.md에는 "Role Assignment" 테이블이 있습니다. Finance에도 추가하면 LLM이 자신의 역할을 명확히 인식합니다.

```markdown
## 역할 분담

| 단계 | 담당 | 작업 | 도구 |
|------|------|------|------|
| 0 | 스크립트 | Drive 파일 다운로드 | `gdrive.py pull` |
| 1 | LLM | 입력 파일 탐색 | Glob, Read |
| 2 | **LLM** | **OCR 추출 + 페이지 분류 + 카테고리 판별** | **Read (Vision)** |
| 3 | 스크립트 | 이름 교정 | `correct_names.py` |
| 4 | **LLM** | **데이터 정리 + 사용자 확인** | **AskUserQuestion** |
| 5 | 스크립트 | Excel 생성 + 데이터 입력 | `process_offering.py` |
| 6 | 스크립트 | 검증 | `process_offering.py verify` |
| 6 | **LLM** | **신규 교인 명부 추가 질문** | **AskUserQuestion** |
| 7 | 스크립트 | Drive 업로드 | `gdrive.py push` |

**LLM 핵심 판단 영역**: 2단계 (OCR + 분류)와 4단계 (사용자 소통)
**스크립트 영역**: 그 외 모든 기계적 처리
```

**적용 위치**: `process-offering.md` 말미에 새 섹션 추가

---

## C. 운영 안정성

### C-1. 부분 재실행 지원

**현재 문제**: `/process-offering 0125` 실행 중 5단계에서 실패하면 0단계부터 다시 시작해야 함 (OCR 재추출 낭비)

**개선 방안**: process-offering.md에 단계별 재시작 지침 추가

```markdown
## 단계별 재시작

특정 단계에서 실패한 경우, 이전 단계를 건너뛰고 재시작할 수 있습니다:

- **5단계(Excel 생성)에서 실패**: "4단계 데이터를 사용하여 Excel만 다시 생성해줘"
  → 4단계에서 확인한 JSON 데이터를 그대로 write 명령에 전달
- **6단계(검증)에서 불일치**: "수정된 데이터로 다시 write해줘"
  → 수정 내용을 반영한 JSON으로 write 재실행 (자동 백업됨)
- **7단계(Drive 업로드)에서 실패**: `python3 scripts/gdrive.py push 0125` 직접 재실행
```

**적용 위치**: `process-offering.md` 끝에 새 섹션

---

### C-2. 동일 날짜 중복 실행 보호

**현재**: `write_data()`는 기존 파일을 백업 후 덮어쓰지만, 같은 날짜로 2번 write하면 첫 번째 결과가 백업으로 밀려남

**개선 방안**: process-offering.md에 중복 실행 주의사항 추가

```markdown
⚠️ **동일 날짜 중복 실행 주의:**
이미 `data/YYYY/MMDD/YYYYMMDD.xlsx`가 존재하는 상태에서 다시 write하면:
1. 기존 파일 → `YYYYMMDD_backup.xlsx`로 백업 (이전 백업은 덮어씀)
2. 새 데이터로 Excel 생성

이전 데이터를 복구하려면:
```bash
python3 scripts/process_offering.py rollback 0125
```
```

**적용 위치**: `process-offering.md` 5단계에 주의사항으로 추가

---

### C-3. 이름 교정 신뢰도 기준 명시

**현재**: `correct_names.py`의 cutoff(0.5)가 코드에만 있고 process-offering.md에 언급 없음

**개선**: LLM이 교정 결과를 해석하는 기준을 명시

```markdown
### 이름 교정 결과 해석

| status | confidence | 의미 | 표시 |
|--------|-----------|------|------|
| exact | 1.0 | 명부에 정확히 일치 | (표시 안 함) |
| corrected | 0.8~0.99 | 높은 확신 교정 | `원본→교정 ✓` |
| corrected | 0.5~0.79 | 낮은 확신 교정 | `원본→교정 ⚠ 확인 필요` |
| unknown | 0.0 | 매칭 없음 | `⚠ 미확인` |

⚠️ **confidence 0.5~0.79인 교정은 사용자에게 반드시 주의를 환기**합니다.
예: `윤선섭→윤순심 (0.63) ⚠ 확인 필요` — 오교정 가능성 있음
```

**적용 위치**: `process-offering.md` 3단계에 추가

---

## D. 확장성 (낮은 우선순위)

현행 유지가 적절하지만, 향후 필요할 경우를 대비한 방향 정리입니다.

### D-1. config 외부화 (필요 시)

다른 교회에서도 사용하려면 `offering_config.py`의 설정을 YAML로 분리:

```
현재: offering_config.py에 Python dict로 하드코딩
향후: config/categories.yaml + offering_config.py가 YAML 로드
```

**현재는 불필요** — 단일 교회 사용이므로 Python 내장이 더 실용적

### D-2. AIP Skill 전환 (필요 시)

AIP 플랫폼에서 범용 서비스로 제공하려면:
- `process-offering.md` → `SKILL.md`로 변환 (Frontmatter에 name, description 추가)
- `CLAUDE.md` → `preset-prompt.md`로 변환 (행동 규칙만 추출)
- Google Drive 연동을 환경 변수 기반으로 완전 분리

**현재는 불필요** — Claude Code Plugin + 슬래시 커맨드가 매주 반복 업무에 최적

---

## 실행 계획

### Phase 7: LLM 판단 정확도 향상

적용 대상: `commands/process-offering.md`

| # | 작업 | 변경 내용 |
|---|------|----------|
| 1 | 의사결정 트리 추가 | 2단계 "자동 분류 기준" → Q1-Q5 트리로 교체 (A-1) |
| 2 | OCR Warning 확장 | 2단계 "금액 인식 주의사항" → 4종 Warning으로 교체 (A-2) |
| 3 | 변환 예시 추가 | 2단계 끝에 통계표/전표 변환 예시 추가 (A-3) |
| 4 | 카테고리 우선순위 | 2단계 "카테고리 판별 기준" → 5단계 우선순위로 교체 (A-4) |
| 5 | 역할 분담표 추가 | 문서 끝에 역할 분담 테이블 추가 (B-2) |
| 6 | 교정 신뢰도 기준 | 3단계에 confidence 해석 테이블 추가 (C-3) |
| 7 | 재시작/중복 실행 | 5단계에 주의사항 + 문서 끝에 재시작 가이드 추가 (C-1, C-2) |

### Phase 8: 문서 정리 (Phase 7 이후)

적용 대상: `CLAUDE.md`

| # | 작업 |
|---|------|
| 1 | CLAUDE.md에서 process-offering.md와 중복되는 실행 지침 제거 |
| 2 | CLAUDE.md를 "설계 결정 + 변경 가이드 + 테스트"에 집중하도록 정리 |
| 3 | 개선 계획에 Phase 7, 8 추가 |

---

*도출 기준: T-Connect Skill 문서화 패턴 (의사결정 트리, Warning, Before/After 예시, 역할 분담표)*
*분석일: 2026-01-28*
