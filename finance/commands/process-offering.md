---
name: process-offering
description: 헌금 전표 이미지/PDF를 읽어 Excel 파일로 자동 입력합니다
argument-hint: "MMDD 또는 YYYYMMDD (예: 0125)"
allowed-tools:
  - AskUserQuestion
  - Glob
  - Bash
  - Read
  - Write
  - Edit
---

# 헌금 전표 자동화

매주 반복되는 "이미지/PDF → Excel 입력" 업무를 자동으로 수행합니다.

인자: `$ARGUMENTS` (MMDD 또는 YYYYMMDD 형식, 예: `0125` 또는 `20260125`)

**날짜 처리**: MMDD(4자리) 입력 시 현재 연도를 자동 적용합니다.
- `0125` → `20260125` (현재 연도 기준)
- `20260125` → 그대로 사용

---

## 수행 단계

### 0단계: Google Drive 파일 가져오기 (선택)

입력 폴더(`data/{YYYY}/{MMDD}/input/`)가 비어있거나 존재하지 않으면:

1. AskUserQuestion: "입력 폴더가 비어있습니다. Google Drive에서 파일을 가져올까요?"
   - "예 - Drive에서 다운로드"
   - "아니오 - 수동으로 파일 넣기"
2. "예" 선택 시:
```bash
python3 scripts/gdrive.py pull $MMDD
```
3. 다운로드 결과 확인 후 다음 단계 진행

### 1단계: 입력 파일 탐색

**날짜 변환:**
- `$ARGUMENTS`가 4자리이면 MMDD로 간주, YYYY = 현재 연도
- 8자리이면 YYYYMMDD 그대로 사용
- YYYY, MMDD 변수를 설정 (예: YYYY=2026, MMDD=0125, YYYYMMDD=20260125)

**입력 폴더 확인:**
- `data/{YYYY}/{MMDD}/input/` 폴더를 Glob으로 확인
- 폴더가 없으면 생성하고 안내: "data/{YYYY}/{MMDD}/input/ 폴더에 전표 이미지(.jpg) 또는 PDF(.pdf)를 넣어주세요."

**파일 유형 판별:**
- `.pdf` 파일이 있으면 → **PDF 모드** (Read 도구로 전체 페이지 일괄 읽기)
- `.jpg` 파일이 있으면 → **이미지 모드** (각 이미지를 개별 Read)
- 둘 다 있으면 → PDF 우선 사용, 이미지는 보조 참고

### 2단계: 데이터 추출 및 페이지 분류

입력 파일을 Read 도구로 읽고, **내용 기반으로** 페이지 유형을 자동 분류합니다.

**페이지 분류 (위에서 아래로 순서대로 판정):**

```
페이지를 읽은 후:
│
├─ Q1: 이전 페이지와 내용이 동일한가? (복사본/영수증 사본)
│   └─ Yes → 중복 (건너뛰기)
│   └─ No → Continue
│
├─ Q2: 특별헌금 키워드(송구영신, 헌신예배, 부활절, 추수감사, 성탄절, 맥추감사)가 포함?
│   └─ Yes → 특별헌금 (아래 특별헌금 처리 흐름 참조)
│   └─ No → Continue
│
├─ Q3: 여러 줄의 (이름, 금액) 쌍이 표 형태로 나열되어 있는가?
│   └─ Yes → 통계표
│   │   └─ 제목에서 카테고리 판별 (아래 카테고리 판별 기준 참조)
│   │   └─ 합계 행이 있으면 교차 검증 수행
│   └─ No → Continue
│
├─ Q4: 단일 건의 금액 + 부서명/단체명이 있는가?
│   └─ Yes → 전표
│   │   └─ 부서명만 있으면 이름=부서명 (예: "장년부", "어린이부")
│   │   └─ 카테고리는 전표 제목/내용에서 판별
│   └─ No → Continue
│
└─ Q5: 위 어디에도 해당하지 않음
    └─ 기타 (사용자에게 유형 질문)
```

**합계 교차 검증 (필수):**
통계표 페이지에서 데이터 추출 시, 반드시 다음을 수행합니다:
1. 개별 항목 금액 합산값과 통계표 기재 합계를 비교
2. 불일치 시 해당 카테고리를 `⚠ 합계 불일치` 플래그 표시
3. 전표가 있는 카테고리는 전표 총액과도 대조하여 이중 검증

**OCR 오인식 주의사항:**

금액:
- 필기체 숫자 혼동: 5↔3, 8↔0, 1↔7 (예: 50,000 → 30,000 / 180,000 → 100,000)
- 쉼표 위치 오류: 580,000 → 58,000 또는 5,800,000
- 검증법: 통계표 합계와 개별 합산 비교 → 불일치 시 가장 큰 차이 항목이 의심
- 의심 항목은 4단계에서 `⚠ 금액 재확인 필요` 태그로 표시

이름:
- 획이 유사한 한글: 호↔모, 건↔진, 천→권, 성↔섭 → correct_names.py가 자모 분해로 대부분 교정
- 쉼표로 연결된 부부 이름: "최정호,박경애" → 하나의 이름으로 유지 (분리하지 않음)
- 교정 불가: 3자 중 2자 이상 동시 오인식 (예: 윤순심→윤선섭) → unknown 처리 → 사용자 확인

카테고리:
- "감사 헌금통계표"에서 "감사"가 잘려서 "헌금통계표"만 보이는 경우 있음 → 합계 금액 규모로 교차 검증 (십일조는 보통 수백만원대)

구조:
- 표의 열 정렬이 깨져서 이름과 금액이 어긋나는 경우 → 행 수와 합계로 검증
- 빈 칸이 있는 행을 건너뛰는 경우 → 통계표 기재 건수와 추출 건수 비교

**특별헌금 감지:**
- 파일명 또는 페이지 내용에 특별헌금 키워드(`scripts/offering_config.py`의 `SPECIAL_OFFERING_KEYWORDS`) 포함 시:
  1. 해당 페이지의 데이터를 별도 추출
  2. AskUserQuestion: "'{키워드}' 헌금이 감지되었습니다. 어떻게 처리할까요?"
     - "포함 - 감사 카테고리로 입력"
     - "포함 - 다른 카테고리 지정"
     - "제외"
  3. 사용자 선택에 따라 해당 카테고리에 추가
  4. 4단계 표시 시 비고란에 `[키워드]` 태그 표시 (예: `[송구영신]`)

**변환 예시: 통계표 → JSON**

OCR 원본 (통계표 페이지):
```
        감사 헌금통계표
이름          금액
정평화        50,000
장년부       150,000
권언성,하공남  80,000
합계         280,000
```

이름 교정 결과:
- 정평화 → exact (명부 일치)
- 장년부 → 부서명이므로 교정 대상 아님
- 권언성 → exact (명부 일치)

최종 JSON:
```json
{
  "감사": [
    {"name": "정평화", "amount": 50000},
    {"name": "장년부", "amount": 150000},
    {"name": "권언성,하공남", "amount": 80000}
  ]
}
```

주의:
- 금액에서 쉼표 제거: `50,000` → `50000`
- 부부 이름은 쉼표 연결 그대로 유지: `"권언성,하공남"`
- 부서명은 교정하지 않고 이름 필드에 그대로: `"장년부"`
- "합계" 행은 JSON에 포함하지 않음 (검증용으로만 사용)

**변환 예시: 전표 → JSON**

OCR 원본 (전표 페이지):
```
        장년부 주일헌금 전표
금액: ₩242,000
```

카테고리 판별: "주일헌금" + "장년부" → 장년부주일

최종 JSON:
```json
{
  "장년부주일": [
    {"name": "장년부", "amount": 242000}
  ]
}
```

주의: 부서 전표는 이름 = 부서명

---

**카테고리 판별 기준 (위에서 아래로 순서대로 적용):**

1. **복합 키워드 (먼저 확인)**
   - "주일헌금" + "장년부" → 장년부주일
   - "주일학교" → 중고등부 (불확실하면 사용자 질문)

2. **정확한 카테고리명 매칭**
   - "감사 헌금통계표", "감사헌금" → 감사
   - "생일감사" → 생일감사
   - "일천번제" → 일천번제
   - "장학", "장학헌금" → 장학
   - "구제", "구제헌금" → 구제
   - "월정선교", "월정헌금", "선교헌금", "정기선교" → 월정선교

3. **단체/부서명 매칭**
   - "산돌회", "산돌전도회" → 샬롬전도회
   - "갈렙전도회" → 갈렙전도회
   - "남전도회" → 남전도회
   - "안나전도회" → 안나전도회
   - 부서명만 있는 경우: 이름=부서명 (어린이부, 중고등부, 청년부)

4. **수식어 없는 기본 매칭**
   - "헌금통계표" (수식어 없음) → 십일조
   - 단, 확실하지 않으면 사용자에게 확인

5. **혼합 카테고리**
   - 하나의 페이지에 여러 카테고리가 있는 경우: 항목별로 분리
   - 카테고리를 알 수 없는 항목 → 사용자에게 질문

### 3단계: 이름 교정

추출된 모든 이름을 교인 명부(`scripts/members.txt`)와 대조합니다.

```bash
echo '{"names": ["추출된이름1", "추출된이름2", ...]}' | python3 scripts/correct_names.py
```

결과:
- **exact** → 정확히 일치, 그대로 사용
- **corrected** → 유사 이름 발견, 자동 교정 (`천인성 → 권언성 ✓`)
- **unknown** → 매칭 없음, `⚠ 미확인` 표시 (신규 교인 가능성)

**교정 신뢰도 해석:**

| status | confidence | 의미 | 4단계 표시 |
|--------|-----------|------|-----------|
| exact | 1.0 | 명부 정확 일치 | (표시 안 함) |
| corrected | 0.8~0.99 | 높은 확신 교정 | `원본→교정 ✓` |
| corrected | 0.5~0.79 | 낮은 확신 교정 | `원본→교정 ⚠ 확인 필요` |
| unknown | 0.0 | 매칭 없음 | `⚠ 미확인` |

confidence 0.5~0.79인 교정은 사용자에게 반드시 주의를 환기합니다.
예: `윤선섭→윤순심 (0.63) ⚠ 확인 필요` — 오교정 가능성 있음

### 4단계: 데이터 정리 및 사용자 확인

추출+교정된 데이터를 카테고리별 테이블로 정리하여 사용자에게 표시합니다.

**표시 형식:**

```
## 추출 결과 (YYYYMMDD)

### 십일조 (18건, 합계: 5,388,000원)
| # | 이름 | 금액 | 비고 |
|---|------|------|------|
| 1 | 최정호 | 578,000 | |
| 2 | 박경애 | 580,000 | |
| 3 | 권언성,하공남 | 450,000 | 천인성→권언성 ✓ |
...

### 감사 (9건, 합계: 460,000원)
| # | 이름 | 금액 | 비고 |
|---|------|------|------|
| 1 | 정평화 | 50,000 | |
| 2 | 장년부 | 150,000 | [송구영신] |
...

---
교정된 이름: 3건
⚠ 미확인 이름: 0건
⚠ 합계 불일치: 구제 (추출 합산: 200,000 ≠ 기재 합계: 220,000) → 의심 항목: 권언성,하공남 30,000 ⚠ 금액 재확인 필요
전체 합계: 7,230,000원
```

**불일치 항목 처리:**
- `⚠ 합계 불일치` 카테고리가 있으면 의심 항목을 명확히 표시
- 합계 불일치 원인으로 의심되는 항목에 `⚠ 금액 재확인 필요` 태그 추가
- 불일치가 있는 경우 사용자에게 반드시 해당 항목 확인을 요청

**AskUserQuestion으로 확인:**
- "추출된 데이터를 확인해주세요. 수정사항이 있으면 알려주세요."
- 불일치가 있는 경우: "⚠ 합계 불일치 항목이 있습니다. 해당 금액을 확인해주세요."
- 선택지: "확인 완료 - Excel 생성 진행", "수정 필요"

### 5단계: Excel 생성 및 입력

사용자 확인 후 Python 스크립트를 호출하여 Excel을 생성합니다.

**5-1. 템플릿 생성** (파일이 없는 경우):
```bash
python3 scripts/process_offering.py create $YYYYMMDD
```

**5-2. 데이터 입력:**
확인된 데이터를 JSON 형식으로 변환하여 전달합니다.

```bash
echo '<JSON데이터>' | python3 scripts/process_offering.py write $YYYYMMDD
```

**데이터 JSON 형식:**
```json
{
    "십일조": [
        {"name": "최정호", "amount": 578000},
        {"name": "박경애", "amount": 580000}
    ],
    "장년부주일": [
        {"name": "장년부", "amount": 242000}
    ],
    "감사": [...],
    ...
}
```

**주의사항:**
- 카테고리 슬롯 수 초과 시 경고 표시
- 부서헌금(어린이부, 중고등부, 청년부, 여전도회, 샬롬전도회 등)은 이름에 부서명 입력
- 특별헌금 이미지는 사용자에게 입력 여부를 질문
- 동일 날짜로 다시 write하면 기존 파일이 `_backup.xlsx`로 밀려남 (이전 백업은 덮어씀). 복구: `python3 scripts/process_offering.py rollback $YYYYMMDD`

### 6단계: 검증 및 명부 업데이트

**6-1. Excel 검증:**
```bash
python3 scripts/process_offering.py verify $YYYYMMDD
```

검증 결과와 이미지 추출 합계를 비교하여 불일치 시 경고합니다.

**6-2. 신규 교인 추가:**
3단계에서 `unknown` 상태였던 이름이 있으면:
- AskUserQuestion으로 "다음 이름을 교인 명부에 추가할까요?" 질문
- 승인 시:
```bash
python3 scripts/correct_names.py --add "새교인이름"
```

### 7단계: Google Drive 업로드 (선택)

검증 완료 후:

1. AskUserQuestion: "Excel 파일을 Google Drive에 업로드할까요?"
   - "예 - Drive에 업로드"
   - "아니오 - 로컬만 유지"
2. "예" 선택 시:
```bash
python3 scripts/gdrive.py push $MMDD
```
3. 업로드 결과 표시

---

## 카테고리 매핑 참고

| 카테고리 | Excel 행 | 슬롯 | 계정코드 |
|----------|----------|------|----------|
| 십일조 | 4-26 | 23 | 10501000000 |
| 장년부주일 | 27 | 1 | 10502000000 |
| 감사 | 28-44 | 17 | 10503000000 |
| 생일감사 | 45-48 | 4 | 10504000000 |
| 일천번제 | 49-52 | 4 | 10505000000 |
| 어린이부 | 53 | 1 | 10301000000 |
| 중고등부 | 54 | 1 | 10302000000 |
| 청년부 | 55 | 1 | 10303000000 |
| 장학 | 56-61 | 6 | 10401000000 |
| 구제 | 62-68 | 7 | 10402000000 |
| 월정선교 | 69-87 | 19 | 242003 |
| 갈렙전도회 | 88 | 1 | 242004 |
| 남전도회 | 89 | 1 | 242005 |
| 안나전도회 | 90 | 1 | 242006 |
| 여전도회 | 91 | 1 | 242007 |
| 셀헌금 | 92 | 1 | 242008 |
| 샬롬전도회 | 93 | 1 | 242009 |
| 통장이자 | 94 | 1 | 242202 |
| 기타수입 | 95 | 1 | 10202000000 |

---

## 역할 분담

| 단계 | 담당 | 작업 | 도구 |
|------|------|------|------|
| 0 | 스크립트 | Drive 파일 다운로드 | `gdrive.py pull` |
| 1 | LLM | 입력 파일 탐색 | Glob, Read |
| 2 | **LLM** | **OCR 추출 + 페이지 분류 + 카테고리 판별** | **Read (Vision)** |
| 3 | 스크립트 | 이름 교정 | `correct_names.py` |
| 4 | **LLM** | **데이터 정리 + 사용자 확인** | **AskUserQuestion** |
| 5 | 스크립트 | Excel 생성 + 데이터 입력 | `process_offering.py` |
| 6 | 스크립트 | 검증 | `process_offering.py verify` |
| 6 | **LLM** | **신규 교인 명부 추가 질문** | **AskUserQuestion** |
| 7 | 스크립트 | Drive 업로드 | `gdrive.py push` |

**LLM 핵심 판단 영역**: 2단계 (OCR + 분류)와 4단계 (사용자 소통)
**스크립트 영역**: 그 외 모든 기계적 처리

---

## 단계별 재시작

특정 단계에서 실패한 경우, 이전 단계를 건너뛰고 재시작할 수 있습니다:

- **5단계(Excel 생성)에서 실패**: "4단계 데이터를 사용하여 Excel만 다시 생성해줘" → 4단계에서 확인한 JSON 데이터를 그대로 write 명령에 전달
- **6단계(검증)에서 불일치**: "수정된 데이터로 다시 write해줘" → 수정 내용을 반영한 JSON으로 write 재실행 (자동 백업됨)
- **7단계(Drive 업로드)에서 실패**: `python3 scripts/gdrive.py push $MMDD` 직접 재실행
