---
name: process-offering
description: 헌금 전표 이미지를 읽어 Excel 파일로 자동 입력합니다
argument-hint: "YYYYMMDD (예: 20260125)"
allowed-tools:
  - AskUserQuestion
  - Glob
  - Bash
  - Read
  - Write
  - Edit
---

# 헌금 전표 자동화

매주 반복되는 "이미지 → Excel 입력" 업무를 자동으로 수행합니다.

인자: `$ARGUMENTS` (YYYYMMDD 형식 날짜, 예: 20260125)

---

## 수행 단계

### 1단계: 이미지 수집

- `$ARGUMENTS/` 폴더가 존재하는지 확인
- 폴더 내 모든 `.jpg` 파일 목록을 Glob으로 확인
- 번호순으로 정렬 (1.jpg, 2.jpg, ... 11.jpg, 이름있는파일.jpg)
- 특별헌금 이미지 (번호가 아닌 이름 파일) 별도 표시

### 2단계: 이미지별 데이터 추출

각 `.jpg` 이미지를 Read 도구로 읽고 데이터를 추출합니다.

**이미지 유형 판별:**
- **(A) 통계표** (표 형태): 제목에서 카테고리 판별, 표에서 (이름, 금액) 쌍 추출, 합계 행으로 교차 검증
- **(B) 전표** (단일 전표): 항목/내역에서 카테고리 판별, 일금/₩ 금액 추출, 내역에 개별 이름/금액 분리

**카테고리 판별 기준:**
- "헌금통계표" 제목 → 십일조
- "감사 헌금통계표" → 감사
- "생일감사" → 생일감사
- "일천번제" → 일천번제
- "장학" → 장학
- "구제" → 구제
- "월정선교" → 월정선교
- 여러 카테고리가 혼합된 경우 (11.jpg 등): 각 항목명으로 분리
- 부서명만 있는 경우: 이름=부서명 (어린이부, 중고등부, 청년부)
- "산돌회" → 샬롬전도회
- "주일헌금" + "장년부" → 장년부주일

### 3단계: 이름 교정

추출된 모든 이름을 교인 명부(`scripts/members.txt`)와 대조합니다.

```bash
echo '{"names": ["추출된이름1", "추출된이름2", ...]}' | python3 scripts/correct_names.py
```

결과:
- **exact** → 정확히 일치, 그대로 사용
- **corrected** → 유사 이름 발견, 자동 교정 (`천인성 → 권언성 ✓`)
- **unknown** → 매칭 없음, `⚠ 미확인` 표시 (신규 교인 가능성)

### 4단계: 데이터 정리 및 사용자 확인

추출+교정된 데이터를 카테고리별 테이블로 정리하여 사용자에게 표시합니다.

**표시 형식:**

```
## 추출 결과 (YYYYMMDD)

### 십일조 (18건, 합계: 5,388,000원)
| # | 이름 | 금액 | 비고 |
|---|------|------|------|
| 1 | 최정호 | 578,000 | |
| 2 | 박경애 | 580,000 | |
| 3 | 권언성,하공남 | 450,000 | 천인성→권언성 ✓ |
...

### 감사 (9건, 합계: 460,000원)
...

---
교정된 이름: 3건
⚠ 미확인 이름: 0건
전체 합계: 7,230,000원
```

**AskUserQuestion으로 확인:**
- "추출된 데이터를 확인해주세요. 수정사항이 있으면 알려주세요."
- 선택지: "확인 완료 - Excel 생성 진행", "수정 필요"

### 5단계: Excel 생성 및 입력

사용자 확인 후 Python 스크립트를 호출하여 Excel을 생성합니다.

**5-1. 템플릿 생성** (파일이 없는 경우):
```bash
python3 scripts/process_offering.py create $ARGUMENTS
```

**5-2. 데이터 입력:**
확인된 데이터를 JSON 형식으로 변환하여 전달합니다.

```bash
echo '<JSON데이터>' | python3 scripts/process_offering.py write $ARGUMENTS
```

**데이터 JSON 형식:**
```json
{
    "십일조": [
        {"name": "최정호", "amount": 578000},
        {"name": "박경애", "amount": 580000}
    ],
    "장년부주일": [
        {"name": "장년부", "amount": 242000}
    ],
    "감사": [...],
    ...
}
```

**주의사항:**
- 카테고리 슬롯 수 초과 시 경고 표시
- 부서헌금(어린이부, 중고등부, 청년부, 여전도회, 샬롬전도회 등)은 이름에 부서명 입력
- 특별헌금 이미지는 사용자에게 입력 여부를 질문

### 6단계: 검증 및 명부 업데이트

**6-1. Excel 검증:**
```bash
python3 scripts/process_offering.py verify $ARGUMENTS
```

검증 결과와 이미지 추출 합계를 비교하여 불일치 시 경고합니다.

**6-2. 신규 교인 추가:**
3단계에서 `unknown` 상태였던 이름이 있으면:
- AskUserQuestion으로 "다음 이름을 교인 명부에 추가할까요?" 질문
- 승인 시:
```bash
python3 scripts/correct_names.py --add "새교인이름"
```

---

## 카테고리 매핑 참고

| 카테고리 | Excel 행 | 슬롯 | 계정코드 |
|----------|----------|------|----------|
| 십일조 | 4-26 | 23 | 10501000000 |
| 장년부주일 | 27 | 1 | 10502000000 |
| 감사 | 28-44 | 17 | 10503000000 |
| 생일감사 | 45-48 | 4 | 10504000000 |
| 일천번제 | 49-52 | 4 | 10505000000 |
| 어린이부 | 53 | 1 | 10301000000 |
| 중고등부 | 54 | 1 | 10302000000 |
| 청년부 | 55 | 1 | 10303000000 |
| 장학 | 56-61 | 6 | 10401000000 |
| 구제 | 62-68 | 7 | 10402000000 |
| 월정선교 | 69-87 | 19 | 242003 |
| 갈렙전도회 | 88 | 1 | 242004 |
| 남전도회 | 89 | 1 | 242005 |
| 안나전도회 | 90 | 1 | 242006 |
| 여전도회 | 91 | 1 | 242007 |
| 셀헌금 | 92 | 1 | 242008 |
| 샬롬전도회 | 93 | 1 | 242009 |
| 통장이자 | 94 | 1 | 242202 |
| 기타수입 | 95 | 1 | 10202000000 |
